<!DOCTYPE html>
<html>
<head>
  <title>前端更新接收页</title>
  <style>
    #noticeArea { 
      border: 2px solid #ff6700; 
      padding: 20px; 
      margin: 30px auto; 
      max-width: 600px; 
      background: #fff8f0;
      border-radius: 8px;
    }
    .notice-title { 
      color: #ff6700; 
      font-weight: bold; 
      font-size: 16px; 
      margin-bottom: 15px;
    }
    .notice-content p { 
      margin: 8px 0; 
      color: #333; 
    }
    button { 
      margin: 10px 10px 0 0; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
    }
    #downloadBtn { 
      background: #2d7dff; 
      color: #fff; 
    }
    #updateBtn { 
      background: #ff6700; 
      color: #fff; 
    }
    #noNotice { 
      text-align: center; 
      color: #666; 
      padding: 10px;
    }
    .page-title { 
      text-align: center; 
      color: #333; 
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <h1 class="page-title">当前页面（未更新前，公告不会消失）</h1>

  <div id="noticeArea">
    <div class="notice-title">📢 待更新公告</div>
    <div id="noticeContent">
      <div id="loading">加载中...正在获取最新更新信息</div>
    </div>
  </div>

<script>
// 替换为你的Render服务域名（如你的服务名为cxk-z875，则无需修改）
const renderDomain = "cxk-z875"; 

window.onload = () => {
  getNotice();
  checkCachedUpdate();
};

async function getNotice() {
  const noticeContent = document.getElementById('noticeContent');
  try {
    const res = await fetch(`https://${renderDomain}.onrender.com/getNoticeInfo`);
    const data = await res.json();

    if (data.success) {
      noticeContent.innerHTML = `
        <div class="notice-content">
          <p>📄 文件名称：${data.notice.fileName}</p>
          <p>📊 文件大小：${data.notice.size}</p>
          <p>⏰ 推送时间：${data.notice.updateTime}</p>
          <button id="downloadBtn" onclick="downloadFile()">1. 下载最新文件</button>
          <button id="updateBtn" onclick="doUpdate()">2. 确认更新（更新后公告消失）</button>
        </div>
      `;
    } else {
      noticeContent.innerHTML = `<div id="noNotice">${data.notice}</div>`;
    }
  } catch (err) {
    noticeContent.innerHTML = `<div id="noNotice">❌ 公告加载失败：${err.message}（检查域名是否正确）</div>`;
  }
}

function downloadFile() {
  window.open(`https://${renderDomain}.onrender.com/downloadLatestFile`, '_blank');
  alert('📥 下载已启动，请在浏览器下载栏查看进度！');
}

async function doUpdate() {
  if (!confirm('⚠️ 确认要更新吗？更新后页面将直接变为最新版，旧版暂存缓存！')) {
    return;
  }

  const noticeArea = document.getElementById('noticeArea');
  try {
    const res = await fetch(`https://${renderDomain}.onrender.com/downloadLatestFile`);
    if (!res.ok) throw new Error('获取最新文件失败，请先确认已下载文件');

    const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = (e) => {
      document.documentElement.innerHTML = e.target.result;
      localStorage.setItem('latestPage', e.target.result);
      alert('✅ 更新成功！页面已变为最新版，公告已隐藏');
    };
    reader.readAsText(blob);
  } catch (err) {
    alert('❌ 更新失败：' + err.message);
  }
}

function checkCachedUpdate() {
  const cachedPage = localStorage.getItem('latestPage');
  if (cachedPage && confirm('📌 检测到缓存的最新页面，是否直接加载？（无需重新更新）')) {
    document.documentElement.innerHTML = cachedPage;
  }
}
</script>
</body>
</html>
