<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ä¸»å®¹å™¨ï¼ˆæ‚¬æµ®çª—å¸¸é©»ç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { height: 100vh; overflow: hidden; position: relative; margin: 0; padding: 0; }
        
        /* 1. é¡µé¢å®¹å™¨ï¼šç”¨iframeæ‰¿è½½æ‰€æœ‰æ–°HTMLï¼Œé¿å…è¦†ç›–æ‚¬æµ®çª— */
        #pageContainer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            border: none; z-index: 1; /* å±‚çº§ä½äºæ‚¬æµ®çª—ï¼Œç¡®ä¿ä¸é®æŒ¡ */
        }

        /* 2. æ‚¬æµ®çƒï¼šå¸¸é©»é¡¶å±‚ï¼Œä¸è¢«iframeè¦†ç›– */
        .float-btn { 
            position: fixed; z-index: 9999; width: 60px; height: 60px; border-radius: 0; box-shadow: 0 3px 15px rgba(0,0,0,0.3); 
            cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; transition: transform 0.2s ease, box-shadow 0.2s ease; 
            background-image: url(https://i.imgs.ovh/2025/09/28/75fraO.jpeg); background-color: #f0f0f0; 
            background-size: cover; background-position: center; background-repeat: no-repeat; 
            padding: 0; margin: 0; border: none; right: 20px; bottom: 50px; 
        }
        .float-btn:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        
        /* 3. æ‚¬æµ®çª—ï¼šå¸¸é©»é¡¶å±‚ï¼ŒåŠŸèƒ½å®Œæ•´ */
        .float-window { 
            position: fixed; z-index: 9998; width: 300px; height: 280px; background: white; border-radius: 12px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.15); overflow: hidden; display: none; opacity: 0; transition: opacity 0.3s ease; 
        }
        .float-window.active { display: block; opacity: 1; }
        
        .window-header { 
            padding: 12px 15px; background: linear-gradient(90deg, #2563eb, #3b82f6); color: white; 
            font-size: 16px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; 
            cursor: move; -webkit-tap-highlight-color: transparent; height: 44px; 
        }
        .modal-back { 
            background: transparent; border: none; color: white; font-size: 14px; cursor: pointer; 
            padding: 4px 8px; border-radius: 4px; transition: background 0.2s ease; display: none; -webkit-tap-highlight-color: transparent; 
        }
        .modal-back:hover { background: rgba(255,255,255,0.1); }
        
        .func-buttons { 
            padding: 10px; display: flex; flex-direction: column; gap: 10px; 
            max-height: calc(280px - 44px); overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        .func-btn { 
            padding: 12px 15px; border-radius: 8px; background: #f8f9fa; font-size: 14px; color: #333; 
            text-align: left; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; 
            display: flex; align-items: center; justify-content: space-between; 
            -webkit-tap-highlight-color: transparent; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .func-btn:hover { background: #f1f3f5; transform: translateY(-1px); }
        .btn-icon { width: 20px; height: 20px; opacity: 0.7; }
        
        .content-panel { 
            padding: 15px; max-height: calc(280px - 44px); overflow-y: auto; 
            -webkit-overflow-scrolling: touch; display: none; 
        }
        .content-panel.active { display: block; }
        
        /* æ›´æ–°æ¨¡å—æ ·å¼ï¼šä¿ç•™æ ¸å¿ƒå…ƒç´  */
        .notice-item { padding: 10px 0; display: block; }
        .notice-title { font-size: 18px; font-weight: 600; color: #2563eb; margin-bottom: 8px; }
        .notice-time { font-size: 12px; color: #999; margin-bottom: 10px; }
        .progress-actions { display: flex; align-items: center; gap: 10px; }
        .download-progress { flex: 1; height: 6px; background: #ebf2ff; border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; background: #2563eb; border-radius: 3px; width: 0%; transition: width 0.03s linear; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s ease; white-space: nowrap; }
        .download-btn { background: #2563eb; color: white; box-shadow: 0 1px 3px rgba(37, 99, 235, 0.2); }
        .download-btn:disabled { background: #93c5fd; cursor: not-allowed; }
        .update-btn { background: #10b981; color: white; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2); display: block; }
        .empty-tip { text-align: center; color: #999; font-size: 14px; line-height: 1.5; padding: 20px 0; border: none; background: transparent; }
    </style>
</head>
<body>
    <!-- 1. é¡µé¢å®¹å™¨ï¼šæ‰€æœ‰æ–°HTMLéƒ½åŠ è½½åˆ°è¿™ä¸ªiframeé‡Œï¼Œè‡ªèº«åŠŸèƒ½å®Œå…¨ç‹¬ç«‹ -->
    <iframe id="pageContainer" src="about:blank"></iframe>

    <!-- 2. æ‚¬æµ®çƒï¼šå¸¸é©»æ˜¾ç¤ºï¼Œä¸å—iframeå†…å®¹å½±å“ -->
    <button class="float-btn" id="floatBtn"></button>

    <!-- 3. æ‚¬æµ®çª—ï¼šå¸¸é©»é¡¶å±‚ï¼ŒåŠŸèƒ½å®Œæ•´ -->
    <div class="float-window" id="floatWindow">
        <div class="window-header" id="windowHeader">
            åŠŸèƒ½é¢æ¿
            <button class="modal-back" id="modalBack">è¿”å›</button>
        </div>
        <div class="func-buttons" id="funcButtons">
            <button class="func-btn" id="btnMy">
                <span>æˆ‘çš„</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/user--v1.png" class="btn-icon" alt="æˆ‘çš„">
            </button>
            <button class="func-btn" id="btnNotice">
                <span>å…¬å‘Šæ›´æ–°</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/announcement--v1.png" class="btn-icon" alt="å…¬å‘Šæ›´æ–°">
            </button>
            <button class="func-btn" id="btnContact">
                <span>è”ç³»ä½œè€…</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/contact-card--v1.png" class="btn-icon" alt="è”ç³»ä½œè€…">
            </button>
            <button class="func-btn" id="btnSetting">
                <span>è®¾ç½®</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/settings--v1.png" class="btn-icon" alt="è®¾ç½®">
            </button>
        </div>
        <div class="content-panel" id="panelNotice">
            <div id="noticeContainer">
                <div class="empty-tip" id="defaultTip">åŠ è½½æ›´æ–°ä¿¡æ¯ä¸­...</div>
                <div class="notice-item" id="pushNotice"></div>
            </div>
        </div>
        <div class="content-panel" id="panelMy">
            <div class="user-name">ç”¨ä¸€ç”Ÿæ‰¾å¯»</div>
            <div class="user-desc">å½“å‰åŠŸèƒ½å¾…å¼€å‘ï¼Œæš‚æ˜¾ç¤ºç”¨æˆ·å</div>
        </div>
        <div class="content-panel" id="panelContact">
            <div class="empty-tip">ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è”ç³»ä½œè€…<br><a href="https://qzone.qq.com/2673976185" target="_blank" style="color: #2563eb; text-decoration: none;">å‰å¾€ä½œè€…QQç©ºé—´</a></div>
        </div>
        <div class="content-panel" id="panelSetting">
            <div class="empty-tip">è®¾ç½®åŠŸèƒ½å¾…å¼€å‘</div>
        </div>
    </div>

    <script>
        (function() {
            if (window.floatingWindowInjected) return;
            window.floatingWindowInjected = true;

            // é…ç½®é¡¹ï¼šæ›¿æ¢æˆä½ çš„RenderæœåŠ¡å
            const config = { 
                domain: "cxk-z875",
                latestNoticeKey: "latestReceivedNotice", // å­˜å‚¨æœ€æ–°æ›´æ–°ä¿¡æ¯
                downloadedFileKey: "downloadedFileStatus", // å­˜å‚¨ä¸‹è½½çŠ¶æ€ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰
                initPageSrc: "" // åˆå§‹åŠ è½½çš„HTMLåœ°å€ï¼ˆå¯é€‰ï¼Œå¦‚"https://xxx.com/index.html"ï¼‰
            };

            // å·¥å…·å‡½æ•°ï¼šä¿ç•™æ ¸å¿ƒåŠŸèƒ½ï¼ˆå“ˆå¸Œæ ¡éªŒã€æ—¶é—´æ ¼å¼åŒ–ç­‰ï¼‰
            const utils = {
                getSafeBottom() { 
                    const p = parseFloat(getComputedStyle(document.body).paddingBottom); 
                    return isNaN(p) ? 20 : p; 
                },
                checkWindowBound(left, top) { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    const sb = utils.getSafeBottom(); 
                    return { 
                        left: Math.max(20, Math.min(left, w - 300 - 20)), 
                        top: Math.max(20, Math.min(top, h - 280 - sb - 20)) 
                    }; 
                },
                getDefaultWindowPos() { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    return utils.checkWindowBound((w-300)/2, (h-280)/2); 
                },
                formatTime(dateStr) {
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}å¹´${String(date.getMonth() + 1).padStart(2, '0')}æœˆ${String(date.getDate()).padStart(2, '0')}æ—¥`;
                },
                getLatestNoticeFromStorage() {
                    const noticeStr = localStorage.getItem(config.latestNoticeKey);
                    return noticeStr ? JSON.parse(noticeStr) : null;
                },
                saveLatestNoticeToStorage(notice) {
                    localStorage.setItem(config.latestNoticeKey, JSON.stringify(notice));
                },
                // æ ‡è®°æ–‡ä»¶å·²ä¸‹è½½ï¼ˆæŒ‰â€œæ–‡ä»¶å+å“ˆå¸Œâ€ç»‘å®šï¼Œæ–°æ–‡ä»¶æ‰é‡ç½®ï¼‰
                markFileAsDownloaded(fileName, fileHash) {
                    localStorage.setItem(config.downloadedFileKey, JSON.stringify({
                        name: fileName,
                        hash: fileHash,
                        time: new Date().getTime()
                    }));
                },
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²ä¸‹è½½ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼Œé™¤éæ–°æ–‡ä»¶æ¨é€ï¼‰
                isFileDownloaded(fileName, fileHash) {
                    const status = localStorage.getItem(config.downloadedFileKey);
                    if (!status) return false;
                    const { name, hash } = JSON.parse(status);
                    return name === fileName && hash === fileHash;
                },
                // è®¡ç®—æ–‡ä»¶å“ˆå¸Œï¼ˆç¡®ä¿æ–°æ–‡ä»¶ç²¾å‡†è¯†åˆ«ï¼‰
                async calculateFileHash(fileContent) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(fileContent);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                }
            };

            // DOMå…ƒç´ ï¼šæ‚¬æµ®çª—ç›¸å…³ï¼ˆç‹¬ç«‹äºiframeï¼Œä¸ä¼šè¢«åˆ é™¤ï¼‰
            const pageContainer = document.getElementById('pageContainer'); // æ–°HTMLå®¹å™¨
            const floatBtn = document.getElementById('floatBtn');
            const floatWindow = document.getElementById('floatWindow');
            const modalBack = document.getElementById('modalBack');
            const funcButtons = document.getElementById('funcButtons');
            const btnMy = document.getElementById('btnMy');
            const btnNotice = document.getElementById('btnNotice');
            const btnContact = document.getElementById('btnContact');
            const btnSetting = document.getElementById('btnSetting');
            const panelNotice = document.getElementById('panelNotice');
            const defaultTip = document.getElementById('defaultTip');
            const pushNotice = document.getElementById('pushNotice');

            // çŠ¶æ€å˜é‡ï¼šå…¨å±€å¸¸é©»ï¼Œä¸å—é¡µé¢åˆ‡æ¢å½±å“
            let btnIsDragging = false, winIsDragging = false, isInMainPanel = true;
            let currentWindowPos = utils.getDefaultWindowPos();
            let currentNoticeData = utils.getLatestNoticeFromStorage() || null;
            let btnDragStart = null, winDragStart = null;
            let downloadInterval = null; // ä¸‹è½½å®šæ—¶å™¨ï¼ˆé¿å…å¡ä½ï¼‰

            // 1. åˆå§‹åŒ–ï¼šåŠ è½½åˆå§‹é¡µé¢ï¼ˆå¯é€‰ï¼‰
            if (config.initPageSrc) {
                pageContainer.src = config.initPageSrc;
            }

            // 2. WebSocketï¼šå…¨å±€å¸¸é©»è¿æ¥ï¼Œå®æ—¶æ¥æ”¶æ–°æ›´æ–°
            let ws;
            let reconnectCount = 0;
            const RECONNECT_DELAY = 1000;

            function initWebSocket() {
                if (ws) ws.close();
                ws = new WebSocket(`wss://${config.domain}.onrender.com`);

                ws.onopen = () => {
                    reconnectCount = 0;
                    autoFetchLatestAnnouncement(); // è¿æ¥æˆåŠŸåæ‹‰å–æœ€æ–°æ›´æ–°
                };

                ws.onclose = () => {
                    reconnectCount++;
                    setTimeout(initWebSocket, RECONNECT_DELAY); // è‡ªåŠ¨é‡è¿
                };

                ws.onerror = (err) => {
                    console.error('WebSocketé”™è¯¯ï¼š', err);
                    if (ws.readyState !== WebSocket.CLOSED) ws.close();
                };

                // æ¥æ”¶æ–°æ›´æ–°ï¼šä»…æ–°æ–‡ä»¶ï¼ˆå“ˆå¸Œå˜åŒ–ï¼‰æ‰è§¦å‘æ›´æ–°
                ws.onmessage = async (e) => {
                    try {
                        const newData = JSON.parse(e.data);
                        if (newData.type === 'notice' && newData.file?.content) {
                            const newFileHash = await utils.calculateFileHash(newData.file.content);
                            newData.file.hash = newFileHash;
                            const isNewFile = !utils.isFileDownloaded(newData.file.name, newFileHash);

                            if (isNewFile) {
                                currentNoticeData = newData;
                                utils.saveLatestNoticeToStorage(newData);
                                autoRenderNotice();
                                autoNotifyAndSwitchPanel(); // æç¤ºç”¨æˆ·æœ‰æ–°æ›´æ–°
                            }
                        }
                    } catch (err) {
                        console.error('è§£ææ›´æ–°æ•°æ®å¤±è´¥ï¼š', err);
                    }
                };
            }

            // 3. æ‹‰å–æœ€æ–°æ›´æ–°ï¼šé¡µé¢åŠ è½½æ—¶å…œåº•
            async function autoFetchLatestAnnouncement() {
                try {
                    const res = await fetch(`https://${config.domain}.onrender.com/getLatestAnnouncement`);
                    if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ˆ${res.status}ï¼‰`);

                    const result = await res.json();
                    if (result.success && result.data?.file?.content) {
                        const newFileHash = await utils.calculateFileHash(result.data.file.content);
                        result.data.file.hash = newFileHash;
                        const isNewFile = !utils.isFileDownloaded(result.data.file.name, newFileHash);

                        if (isNewFile) {
                            currentNoticeData = result.data;
                            utils.saveLatestNoticeToStorage(result.data);
                        }
                        autoRenderNotice(); // æ¸²æŸ“æŒ‰é’®çŠ¶æ€ï¼ˆä¸‹è½½/æ›´æ–°ï¼‰
                    } else if (!currentNoticeData) {
                        defaultTip.style.display = 'block';
                        pushNotice.style.display = 'none';
                    } else {
                        autoRenderNotice();
                    }
                } catch (err) {
                    console.error('æ‹‰å–æ›´æ–°å¤±è´¥ï¼š', err);
                    if (currentNoticeData) {
                        autoRenderNotice(); // å¤±è´¥ä¹Ÿæ˜¾ç¤ºå·²æœ‰çŠ¶æ€
                    } else {
                        defaultTip.textContent = 'æš‚æ— æ›´æ–°';
                    }
                    setTimeout(autoFetchLatestAnnouncement, 10000); // 10ç§’åé‡è¯•
                }
            }

            // 4. æ¸²æŸ“æ›´æ–°æ¨¡å—ï¼šæŒ‰é’®çŠ¶æ€æ°¸ä¹…å›ºå®šï¼ˆä¸‹è½½â†’æ›´æ–°ï¼‰
            function autoRenderNotice() {
                if (!currentNoticeData?.file) {
                    defaultTip.style.display = 'block';
                    pushNotice.style.display = 'none';
                    return;
                }

                const { name: fileName, hash } = currentNoticeData.file;
                const isDownloaded = utils.isFileDownloaded(fileName, hash);

                // ä»…æ¸²æŸ“æ ¸å¿ƒå…ƒç´ ï¼šæ›´æ–°æ ‡é¢˜ã€æ—¶é—´ã€è¿›åº¦æ¡ã€æŒ‰é’®
                const noticeHtml = `
                    <div class="notice-title">æ›´æ–°</div>
                    <div class="notice-time">æ›´æ–°æ—¶é—´ï¼š${utils.formatTime(currentNoticeData.date || new Date())}</div>
                    <div class="progress-actions">
                        <div class="download-progress" id="downloadProgress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <button class="action-btn ${isDownloaded ? 'update-btn' : 'download-btn'}" 
                                id="downloadBtn" 
                                onclick="${isDownloaded ? 'markAsUpdated()' : 'startDownload()'}">
                            ${isDownloaded ? 'æ›´æ–°' : 'ä¸‹è½½'}
                        </button>
                    </div>
                `;

                pushNotice.innerHTML = noticeHtml;
                defaultTip.style.display = 'none';
                pushNotice.style.display = 'block';
            }

            // 5. ä¸‹è½½é€»è¾‘ï¼šä¸‹è½½å®Œæˆåæ°¸ä¹…å˜â€œæ›´æ–°â€
            window.startDownload = async function() {
                const downloadProgress = document.getElementById('downloadProgress');
                const progressBar = document.getElementById('progressBar');
                const downloadBtn = document.getElementById('downloadBtn');
                const { name: fileName, content, hash } = currentNoticeData.file;

                if (!downloadProgress || !progressBar || !downloadBtn || !content) return;

                // æ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œé¿å…é‡å¤ä¸‹è½½å¡ä½
                if (downloadInterval) clearInterval(downloadInterval);

                // ä¸‹è½½ä¸­çŠ¶æ€
                downloadBtn.textContent = 'ä¸‹è½½ä¸­';
                downloadBtn.disabled = true;
                progressBar.style.width = '0%';

                // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå®é™…å¯æ›¿æ¢ä¸ºçœŸå®ä¸‹è½½è¿›åº¦ï¼‰
                let progress = 0;
                downloadInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;

                    if (progress >= 100) {
                        clearInterval(downloadInterval);
                        // ä¸‹è½½å®Œæˆï¼šæ°¸ä¹…åˆ‡æ¢ä¸ºâ€œæ›´æ–°â€æŒ‰é’®
                        downloadBtn.textContent = 'æ›´æ–°';
                        downloadBtn.className = 'action-btn update-btn';
                        downloadBtn.onclick = markAsUpdated;
                        downloadBtn.disabled = false;
                        // æ ‡è®°å·²ä¸‹è½½ï¼ˆlocalStorageæ°¸ä¹…å­˜å‚¨ï¼Œåˆ·æ–°/åˆ‡æ¢é¡µé¢ä¸é‡ç½®ï¼‰
                        utils.markFileAsDownloaded(fileName, hash);
                    }
                }, 100);
            };

            // 6. æ›´æ–°é€»è¾‘ï¼šåŠ è½½æ–°HTMLåˆ°iframeï¼Œæ‚¬æµ®çª—ä¸å—å½±å“
            window.markAsUpdated = async function() {
                if (!confirm('âš ï¸ ç¡®è®¤æ›´æ–°ï¼Ÿæ›´æ–°åå°†åŠ è½½æœ€æ–°é¡µé¢')) return;

                try {
                    const { content: newHtmlContent } = currentNoticeData.file;
                    if (!newHtmlContent) throw new Error('æ— æœ€æ–°é¡µé¢å†…å®¹');

                    // å…³é”®ï¼šä¸è¦†ç›–bodyï¼Œè€Œæ˜¯æŠŠæ–°HTMLåŠ è½½åˆ°iframeï¼ˆæ–°é¡µé¢åŠŸèƒ½å®Œå…¨ç‹¬ç«‹ï¼‰
                    // æ–¹å¼1ï¼šç›´æ¥åŠ è½½HTMLå†…å®¹ï¼ˆé€‚åˆæ— è·¨åŸŸçš„æœ¬åœ°/åŒåŸŸå†…å®¹ï¼‰
                    pageContainer.contentDocument.documentElement.innerHTML = newHtmlContent;
                    
                    // æ–¹å¼2ï¼šè‹¥æ–°HTMLæ˜¯è¿œç¨‹åœ°å€ï¼Œç”¨srcåŠ è½½ï¼ˆäºŒé€‰ä¸€ï¼Œæ³¨é‡Šæ‰æ–¹å¼1å³å¯ï¼‰
                    // pageContainer.src = "https://xxx.com/new-page.html";

                    alert('âœ… æ›´æ–°æˆåŠŸï¼é¡µé¢å·²åŠ è½½ï¼Œæ‚¬æµ®çª—å¯æ­£å¸¸ä½¿ç”¨');
                } catch (err) {
                    alert(`âŒ æ›´æ–°å¤±è´¥ï¼š${err.message}ï¼Œè¯·ç¨ç­‰é‡è¯•`);
                }
            };

            // 7. æ‚¬æµ®çª—è¾…åŠ©åŠŸèƒ½ï¼šæç¤ºã€é¢æ¿åˆ‡æ¢ã€æ‹–æ‹½
            function autoNotifyAndSwitchPanel(tip = 'æ”¶åˆ°æ–°æ›´æ–°') {
                // ç³»ç»Ÿé€šçŸ¥
                if (Notification.permission === 'granted') {
                    new Notification(tip, {
                        body: `æ›´æ–°æ—¶é—´ï¼š${utils.formatTime(currentNoticeData.date)}`,
                        icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(perm => {
                        if (perm === 'granted') {
                            new Notification(tip, {
                                body: `æ›´æ–°æ—¶é—´ï¼š${utils.formatTime(currentNoticeData.date)}`,
                                icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                            });
                        }
                    });
                }

                // å¼¹çª—æç¤º
                alert(`ğŸ‰ ${tip}`);

                // è‡ªåŠ¨åˆ‡æ¢åˆ°æ›´æ–°é¢æ¿
                if (!panelNotice.classList.contains('active')) {
                    switchContentPanel('panelNotice');
                }

                // å±•å¼€æ‚¬æµ®çª—
                if (!floatWindow.classList.contains('active')) {
                    floatWindow.classList.add('active');
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }

            // é¢æ¿åˆ‡æ¢
            function switchContentPanel(targetId) {
                funcButtons.style.display = 'none';
                [panelNotice, document.getElementById('panelMy'), document.getElementById('panelContact'), document.getElementById('panelSetting')].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                document.getElementById(targetId).classList.add('active');
                document.getElementById(targetId).style.display = 'block';
                modalBack.style.display = 'block';
                isInMainPanel = false;

                if (targetId === 'panelNotice') autoRenderNotice();
            }

            // è¿”å›ä¸»é¢æ¿
            function backToMainPanel() {
                [panelNotice, document.getElementById('panelMy'), document.getElementById('panelContact'), document.getElementById('panelSetting')].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                funcButtons.style.display = 'flex';
                modalBack.style.display = 'none';
                isInMainPanel = true;
            }

            // æ‚¬æµ®çƒæ‹–æ‹½
            floatBtn.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                btnDragStart = { x: touch.clientX, y: touch.clientY, rect: floatBtn.getBoundingClientRect() };
                btnIsDragging = false;
            }, { passive: true });

            floatBtn.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const dx = touch.clientX - btnDragStart.x;
                const dy = touch.clientY - btnDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    btnIsDragging = true;
                    const winW = document.documentElement.clientWidth;
                    const winH = document.documentElement.clientHeight;
                    const safeBottom = utils.getSafeBottom();
                    const boundedLeft = Math.max(20, Math.min(btnDragStart.rect.left + dx, winW - 60 - 20));
                    const boundedTop = Math.max(20, Math.min(btnDragStart.rect.top + dy, winH - 60 - safeBottom - 20));
                    floatBtn.style.left = `${boundedLeft}px`;
                    floatBtn.style.top = `${boundedTop}px`;
                }
            }, { passive: false });

            // æ‚¬æµ®çƒç‚¹å‡»ï¼ˆå±•å¼€/æ”¶èµ·æ‚¬æµ®çª—ï¼‰
            floatBtn.addEventListener('click', () => {
                if (btnIsDragging) return;
                floatWindow.classList.toggle('active');
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                    autoRenderNotice(); // å±•å¼€æ—¶åˆ·æ–°æŒ‰é’®çŠ¶æ€
                }
            });

            // æ‚¬æµ®çª—æ‹–æ‹½
            document.getElementById('windowHeader').addEventListener('touchstart', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                winDragStart = { x: touch.clientX, y: touch.clientY, rect: floatWindow.getBoundingClientRect() };
                winIsDragging = false;
            }, { passive: true });

            document.getElementById('windowHeader').addEventListener('touchmove', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                const dx = touch.clientX - winDragStart.x;
                const dy = touch.clientY - winDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    winIsDragging = true;
                    currentWindowPos = { left: winDragStart.rect.left + dx, top: winDragStart.rect.top + dy };
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }, { passive: false });

            // é¢æ¿æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            modalBack.addEventListener('click', backToMainPanel);
            btnMy.addEventListener('click', () => switchContentPanel('panelMy'));
            btnNotice.addEventListener('click', () => switchContentPanel('panelNotice'));
            btnContact.addEventListener('click', () => switchContentPanel('panelContact'));
            btnSetting.addEventListener('click', () => switchContentPanel('panelSetting'));

            // çª—å£ resize é€‚é…
            window.addEventListener('resize', () => {
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            });

            // åˆå§‹åŒ–ï¼šå¯åŠ¨WebSocket+æ‹‰å–æ›´æ–°
            document.addEventListener('DOMContentLoaded', () => {
                initWebSocket();
                autoFetchLatestAnnouncement();
            });
        })();
    </script>
</body>
</html>
