<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ‚¬æµ®åŠŸèƒ½é¢æ¿ï¼ˆå…¨è‡ªåŠ¨æ¥æ”¶æ›´æ–°ï¼‰</title>
    <style>
        /* 100%ä¿ç•™æ‰€æœ‰æ‚¬æµ®çƒæ ·å¼ï¼Œæ— æ‰‹åŠ¨åˆ·æ–°æŒ‰é’® */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { height: 100vh; overflow: hidden; position: relative; background: #f5f7fa; }
        
        .html-render-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1000; display: none; border: none;
        }
        .load-tip {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; font-size: 14px; z-index: 1000; display: none;
        }
        .float-btn { 
            position: fixed; z-index: 1002; width: 60px; height: 60px; border-radius: 0; box-shadow: 0 3px 15px rgba(0,0,0,0.3); 
            cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; transition: transform 0.2s ease, box-shadow 0.2s ease; 
            background-image: url(https://i.imgs.ovh/2025/09/28/75fraO.jpeg); background-color: #f0f0f0; 
            background-size: cover; background-position: center; background-repeat: no-repeat; 
            padding: 0; margin: 0; border: none; right: 20px; bottom: 50px; 
        }
        .float-btn:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        
        .float-window { 
            position: fixed; z-index: 1001; width: 300px; height: 280px; background: white; border-radius: 12px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.15); overflow: hidden; display: none; opacity: 0; transition: opacity 0.3s ease; 
        }
        .float-window.active { display: block; opacity: 1; }
        
        .window-header { 
            padding: 12px 15px; background: linear-gradient(90deg, #2563eb, #3b82f6); color: white; 
            font-size: 16px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; 
            cursor: move; -webkit-tap-highlight-color: transparent; height: 44px; 
        }
        .modal-back { 
            background: transparent; border: none; color: white; font-size: 14px; cursor: pointer; 
            padding: 4px 8px; border-radius: 4px; transition: background 0.2s ease; display: none; -webkit-tap-highlight-color: transparent; 
        }
        .modal-back:hover { background: rgba(255,255,255,0.1); }
        
        .func-buttons { 
            padding: 10px; display: flex; flex-direction: column; gap: 10px; 
            max-height: calc(280px - 44px); overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        .func-btn { 
            padding: 12px 15px; border-radius: 8px; background: #f8f9fa; font-size: 14px; color: #333; 
            text-align: left; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; 
            display: flex; align-items: center; justify-content: space-between; 
            -webkit-tap-highlight-color: transparent; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .func-btn:hover { background: #f1f3f5; transform: translateY(-1px); }
        .btn-icon { width: 20px; height: 20px; opacity: 0.7; }
        
        .content-panel { 
            padding: 15px; max-height: calc(280px - 44px); overflow-y: auto; 
            -webkit-overflow-scrolling: touch; display: none; 
        }
        .content-panel.active { display: block; }
        
        .user-name { font-size: 18px; font-weight: 600; color: #2563eb; margin-bottom: 10px; }
        .user-desc { font-size: 14px; color: #666; line-height: 1.5; }
        .empty-tip { text-align: center; color: #999; font-size: 14px; line-height: 1.5; padding: 20px 0; }
        
        .notice-item { 
            margin-bottom: 10px; padding: 10px; background: #f9faff; border-radius: 8px; 
            border: 1px solid #ebf2ff; display: block; 
        }
        .notice-title { font-weight: 600; color: #2563eb; margin-bottom: 5px; font-size: 15px; }
        .notice-time { font-size: 12px; color: #999; margin-bottom: 6px; }
        .notice-content { font-size: 13px; color: #666; line-height: 1.4; margin-bottom: 12px; word-break: break-word; }
        
        .progress-actions { display: flex; align-items: center; gap: 8px; width: 100%; margin-bottom: 10px; }
        .progress-left { flex: 1; }
        .download-progress { height: 8px; background: #ebf2ff; border-radius: 4px; overflow: hidden; display: none; width: 100%; }
        .progress-bar { height: 100%; background: #2563eb; border-radius: 4px; width: 0%; transition: width 0.03s linear; }
        .progress-text { font-size: 11px; color: #999; margin-top: 3px; text-align: left; }
        .action-btns { width: auto; }
        
        .action-btn { 
            padding: 6px 12px; border: none; border-radius: 6px; font-size: 12px; 
            cursor: pointer; transition: background 0.2s ease; white-space: nowrap; 
        }
        .download-btn { background: #2563eb; color: white; box-shadow: 0 1px 3px rgba(37, 99, 235, 0.2); }
        .download-btn:disabled { background: #93c5fd; cursor: not-allowed; }
        .update-btn { background: #10b981; color: white; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2); display: none; }
        .file-download-btn { 
            background: #f59e0b; color: white; box-shadow: 0 1px 3px rgba(245, 158, 11, 0.2); 
            margin-top: 8px; width: 100%; padding: 8px 0; 
        }
        .file-download-btn:hover { background: #d97706; }
        .file-info-tip { font-size: 12px; color: #999; margin-top: 5px; text-align: center; }
        
        .status-badge { 
            display: inline-block; padding: 2px 8px; border-radius: 12px; 
            font-size: 11px; font-weight: 500; margin-left: 8px; 
        }
        .status-new { background: #fef3c7; color: #92400e; }
        .status-updated { background: #d1fae5; color: #065f46; }
        .status-has-file { background: #dbeafe; color: #1e40af; margin-left: 5px; }
    </style>
</head>
<body>
    <iframe class="html-render-container" id="htmlRenderIframe" onload="hideLoadTip()" onerror="showErrorTip()"></iframe>
    <div class="load-tip" id="loadTip">åŠ è½½ä¸­...</div>
    <button class="float-btn" id="floatBtn"></button>
    <div class="float-window" id="floatWindow">
        <div class="window-header" id="windowHeader">
            åŠŸèƒ½é¢æ¿ï¼ˆå…¨è‡ªåŠ¨æ¥æ”¶æ›´æ–°ï¼‰
            <button class="modal-back" id="modalBack">è¿”å›</button>
        </div>
        <div class="func-buttons" id="funcButtons">
            <button class="func-btn" id="btnMy">
                <span>æˆ‘çš„</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/user--v1.png" class="btn-icon" alt="æˆ‘çš„">
            </button>
            <button class="func-btn" id="btnNotice">
                <span>å…¬å‘Šæ›´æ–°</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/announcement--v1.png" class="btn-icon" alt="å…¬å‘Šæ›´æ–°">
            </button>
            <button class="func-btn" id="btnContact">
                <span>è”ç³»ä½œè€…</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/contact-card--v1.png" class="btn-icon" alt="è”ç³»ä½œè€…">
            </button>
            <button class="func-btn" id="btnSetting">
                <span>è®¾ç½®</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/settings--v1.png" class="btn-icon" alt="è®¾ç½®">
            </button>
        </div>
        <div class="content-panel" id="panelMy">
            <div class="user-name">ç”¨ä¸€ç”Ÿæ‰¾å¯»</div>
            <div class="user-desc">å½“å‰åŠŸèƒ½å¾…å¼€å‘ï¼Œæš‚æ˜¾ç¤ºç”¨æˆ·å<br>åç»­å¯æ·»åŠ å¤´åƒã€ä¸ªäººä¿¡æ¯ç­‰</div>
        </div>
        <div class="content-panel" id="panelNotice">
            <div id="noticeContainer">
                <div class="empty-tip" id="defaultTip">æš‚æ— å…¬å‘Š<br>æ–°å…¬å‘Šå°†è‡ªåŠ¨æ˜¾ç¤ºï¼ˆæ— éœ€åˆ·æ–°ï¼‰</div>
                <div class="notice-item" id="pushNotice"></div>
            </div>
        </div>
        <div class="content-panel" id="panelContact">
            <div class="empty-tip">ç‚¹å‡»ä¸‹æ–¹é“¾æ¥è”ç³»ä½œè€…<br><a href="https://qzone.qq.com/2673976185" target="_blank" style="color: #2563eb; text-decoration: none;">å‰å¾€ä½œè€…QQç©ºé—´</a></div>
        </div>
        <div class="content-panel" id="panelSetting">
            <div class="empty-tip">è®¾ç½®åŠŸèƒ½å¾…å¼€å‘<br>æ•¬è¯·æœŸå¾…</div>
        </div>
    </div>

    <script>
        (function() {
            if (window.floatingWindowInjected) return;
            window.floatingWindowInjected = true;

            // é…ç½®ï¼ˆå’Œåç«¯æœåŠ¡åä¸€è‡´ï¼‰
            const config = { 
                floatBtnSize: 60, safeMargin: 20, defaultSafeBottom: 20, 
                windowWidth: 300, windowHeight: 280,
                domain: "cxk-z875" // ä½ çš„RenderæœåŠ¡åï¼Œä¸è¦æ”¹
            };

            // å·¥å…·å‡½æ•°
            const utils = {
                getSafeBottom() { 
                    const p = parseFloat(getComputedStyle(document.body).paddingBottom); 
                    return isNaN(p) ? config.defaultSafeBottom : p; 
                },
                checkWindowBound(left, top) { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    const sb = utils.getSafeBottom(); 
                    return { 
                        left: Math.max(config.safeMargin, Math.min(left, w - config.windowWidth - config.safeMargin)), 
                        top: Math.max(config.safeMargin, Math.min(top, h - config.windowHeight - sb - config.safeMargin)) 
                    }; 
                },
                getDefaultWindowPos() { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    return utils.checkWindowBound((w-config.windowWidth)/2, (h-config.windowHeight)/2); 
                },
                formatFileSize(size) { // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                    if (size < 1024) return `${size}B`;
                    if (size < 1024 * 1024) return `${(size / 1024).toFixed(2)}KB`;
                    return `${(size / (1024 * 1024)).toFixed(2)}MB`;
                },
                // æ–°å¢ï¼šè®°å½•å·²æ¥æ”¶çš„æœ€æ–°å…¬å‘Šæ—¶é—´ï¼ˆé¿å…é‡å¤æ˜¾ç¤ºï¼‰
                getLastReceivedTime() {
                    return localStorage.getItem('lastReceivedAnnouncementTime') || '2000-01-01 00:00:00';
                },
                setLastReceivedTime(time) {
                    localStorage.setItem('lastReceivedAnnouncementTime', time);
                }
            };

            // å…ƒç´ å¼•ç”¨
            const floatBtn = document.getElementById('floatBtn');
            const floatWindow = document.getElementById('floatWindow');
            const modalBack = document.getElementById('modalBack');
            const funcButtons = document.getElementById('funcButtons');
            const btnMy = document.getElementById('btnMy');
            const btnNotice = document.getElementById('btnNotice');
            const btnContact = document.getElementById('btnContact');
            const btnSetting = document.getElementById('btnSetting');
            const panelMy = document.getElementById('panelMy');
            const panelNotice = document.getElementById('panelNotice');
            const panelContact = document.getElementById('panelContact');
            const panelSetting = document.getElementById('panelSetting');
            const defaultTip = document.getElementById('defaultTip');
            const pushNotice = document.getElementById('pushNotice');
            const loadTip = document.getElementById('loadTip');
            let downloadProgress, progressBar, progressText, downloadBtn, updateBtn, fileDownloadBtn;

            // çŠ¶æ€å˜é‡
            let btnIsDragging = false, winIsDragging = false, isInMainPanel = true;
            let currentWindowPos = utils.getDefaultWindowPos();
            let currentNoticeData = null;
            let downloadInterval = null;
            let btnDragStart = null, winDragStart = null;
            let cachedFileNames = JSON.parse(localStorage.getItem('cachedFileNames')) || [];

            // 1. æ ¸å¿ƒ1ï¼šWebSocketå®æ—¶æ¥æ”¶ï¼ˆåœ¨çº¿æ—¶ç§’æ¨ï¼Œé‡è¿åè¡¥æ‹‰ï¼‰
            let ws;
            let reconnectCount = 0;
            const RECONNECT_DELAY = 1000; // é‡è¿é—´éš”ï¼ˆ1ç§’ï¼Œé¿å…é¢‘ç¹è¯·æ±‚ï¼‰

            function initWebSocket() {
                // å…³é—­æ—§è¿æ¥ï¼Œé¿å…é‡å¤
                if (ws) {
                    ws.close();
                    ws = null;
                }

                ws = new WebSocket(`wss://${config.domain}.onrender.com`);

                // è¿æ¥æˆåŠŸï¼šç«‹å³æ‹‰å–æœ€æ–°å…¬å‘Šï¼ˆç¦»çº¿åä¸Šçº¿è¡¥æ”¶ï¼‰
                ws.onopen = () => {
                    reconnectCount = 0;
                    loadTip.style.display = 'none';
                    console.log('âœ… WebSocketè¿æ¥æˆåŠŸï¼ˆå®æ—¶æ¥æ”¶æ›´æ–°ï¼‰');
                    // è¿æ¥åè‡ªåŠ¨æ‹‰å–ï¼ˆè¡¥æ”¶ç¦»çº¿æœŸé—´çš„å…¬å‘Šï¼‰
                    autoFetchLatestAnnouncement();
                };

                // è¿æ¥æ–­å¼€ï¼šè‡ªåŠ¨é‡è¿
                ws.onclose = () => {
                    reconnectCount++;
                    console.log(`âŒ WebSocketæ–­å¼€ï¼Œ${RECONNECT_DELAY}msåé‡è¿ï¼ˆç¬¬${reconnectCount}æ¬¡ï¼‰`);
                    setTimeout(initWebSocket, RECONNECT_DELAY);
                    loadTip.textContent = 'è¿æ¥ä¸­...';
                    loadTip.style.display = 'block';
                };

                // è¿æ¥é”™è¯¯ï¼šé‡è¿
                ws.onerror = (err) => {
                    console.error('âŒ WebSocketé”™è¯¯ï¼š', err);
                    loadTip.textContent = 'è¿æ¥é”™è¯¯ï¼Œé‡è¯•ä¸­...';
                    loadTip.style.display = 'block';
                    if (ws.readyState !== WebSocket.CLOSED) {
                        ws.close();
                    }
                };

                // å®æ—¶æ¥æ”¶å…¬å‘Šï¼ˆåœ¨çº¿æ—¶è§¦å‘ï¼‰
                ws.onmessage = (e) => {
                    console.log('ğŸ“¥ å®æ—¶æ”¶åˆ°æ›´æ–°æ•°æ®ï¼š', e.data);
                    try {
                        const newData = JSON.parse(e.data);
                        // ä»…å¤„ç†å…¬å‘Šç±»å‹æ•°æ®
                        if (newData.type === 'notice') {
                            // è¿‡æ»¤é‡å¤æ•°æ®ï¼ˆé¿å…å¤šæ¬¡æ¨é€ï¼‰
                            const lastTime = utils.getLastReceivedTime();
                            if (newData.date > lastTime) {
                                currentNoticeData = newData;
                                utils.setLastReceivedTime(newData.date); // è®°å½•æœ€æ–°æ—¶é—´
                                autoRenderNotice(); // è‡ªåŠ¨æ¸²æŸ“
                                autoNotifyAndSwitchPanel(); // è‡ªåŠ¨å¼¹çª—+åˆ‡é¢æ¿
                            }
                        }
                    } catch (err) {
                        console.error('âŒ è§£ææ›´æ–°æ•°æ®å¤±è´¥ï¼š', err);
                    }
                };
            }

            // 2. æ ¸å¿ƒ2ï¼šè‡ªåŠ¨æ‹‰å–æœ€æ–°å…¬å‘Šï¼ˆç¦»çº¿ä¸Šçº¿è¡¥æ”¶ã€é¡µé¢åŠ è½½æ—¶è§¦å‘ï¼‰
            async function autoFetchLatestAnnouncement() {
                try {
                    console.log('ğŸ” è‡ªåŠ¨æ‹‰å–æœ€æ–°å…¬å‘Šï¼ˆè¡¥æ”¶ç¦»çº¿æ›´æ–°ï¼‰');
                    const res = await fetch(`https://${config.domain}.onrender.com/getLatestAnnouncement`);
                    if (!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${res.status}ï¼‰`);

                    const result = await res.json();
                    if (result.success && result.data) {
                        const lastTime = utils.getLastReceivedTime();
                        // æœ‰æ–°å…¬å‘Šï¼ˆç¦»çº¿æœŸé—´ä¸Šä¼ çš„ï¼‰ï¼Œè‡ªåŠ¨æ›´æ–°
                        if (result.data.date > lastTime) {
                            currentNoticeData = result.data;
                            utils.setLastReceivedTime(result.data.date);
                            autoRenderNotice();
                            autoNotifyAndSwitchPanel('ç¦»çº¿æœŸé—´æ”¶åˆ°æ–°å…¬å‘Š');
                        } else {
                            console.log('â„¹ï¸ å½“å‰å·²æ˜¯æœ€æ–°å…¬å‘Šï¼Œæ— éœ€æ›´æ–°');
                            currentNoticeData = result.data;
                            autoRenderNotice();
                        }
                    } else {
                        console.log('â„¹ï¸ æš‚æ— å…¬å‘Šï¼š', result.data);
                        if (!currentNoticeData) autoRenderNotice();
                    }
                } catch (err) {
                    console.error('âŒ è‡ªåŠ¨æ‹‰å–å…¬å‘Šå¤±è´¥ï¼š', err);
                    // å¤±è´¥å10ç§’å†è¯•ä¸€æ¬¡ï¼ˆå…œåº•ï¼‰
                    setTimeout(autoFetchLatestAnnouncement, 10000);
                }
            }

            // 3. æ ¸å¿ƒ3ï¼šè‡ªåŠ¨æ¸²æŸ“å…¬å‘Šï¼ˆæ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œæ•°æ®æ›´æ–°å³æ¸²æŸ“ï¼‰
            function autoRenderNotice() {
                if (!currentNoticeData || currentNoticeData.type !== 'notice') {
                    defaultTip.style.display = 'block';
                    pushNotice.style.display = 'none';
                    return;
                }

                // å­—æ®µå®¹é”™ï¼ˆé¿å…ç¼ºå¤±å¯¼è‡´æ¸²æŸ“å¤±è´¥ï¼‰
                const title = currentNoticeData.title || 'æœªå‘½åå…¬å‘Š';
                const time = currentNoticeData.date || new Date().toLocaleString();
                const content = currentNoticeData.content || 'æ–°çš„HTMLæ–‡ä»¶å·²æ›´æ–°';
                const hasFile = !!currentNoticeData.file;
                const fileName = hasFile ? (currentNoticeData.file.name || 'æœªå‘½å.html') : '';
                const fileSize = hasFile ? utils.formatFileSize(currentNoticeData.file.size) : '';
                const isCached = hasFile && cachedFileNames.includes(fileName);

                // æ¸²æŸ“å…¬å‘ŠHTML
                const noticeHtml = `
                    <div class="notice-title">
                        ${title}
                        <span class="status-badge status-new">æœªæ›´æ–°ï¼ˆå¸¸é©»ï¼‰</span>
                        ${hasFile ? `<span class="status-badge status-has-file">å«æ–‡ä»¶</span>` : ''}
                    </div>
                    <div class="notice-time">æ›´æ–°æ—¶é—´ï¼š${time}</div>
                    <div class="notice-content">${content}</div>
                    <div class="progress-actions">
                        <div class="progress-left">
                            <div class="download-progress" id="downloadProgress">
                                <div class="progress-bar" id="progressBar"></div>
                            </div>
                            <div class="progress-text" id="progressText">è¿›åº¦ï¼š0%</div>
                        </div>
                        <div class="action-btns">
                            <button class="action-btn download-btn" id="downloadBtn" onclick="startDownload()">ä¸‹è½½</button>
                            <button class="action-btn update-btn" id="updateBtn" onclick="markAsUpdated()">æ›´æ–°</button>
                        </div>
                    </div>
                    ${hasFile ? `
                        <div style="text-align: center;">
                            <button class="action-btn file-download-btn" id="fileDownloadBtn" onclick="downloadFile()">
                                ${isCached ? 'é‡æ–°ä¸‹è½½' : 'ä¸‹è½½'}HTMLæ–‡ä»¶ï¼ˆ${fileName}ï¼‰
                            </button>
                            <div class="file-info-tip">
                                å¤§å°ï¼š${fileSize} | ${isCached ? 'å·²ç¼“å­˜ï¼Œç‚¹å‡»é‡æ–°è·å–' : 'ç‚¹å‡»ä¿å­˜åˆ°æœ¬åœ°'}
                            </div>
                        </div>
                    ` : ''}
                `;

                pushNotice.innerHTML = noticeHtml;
                defaultTip.style.display = 'none';
                pushNotice.style.display = 'block';

                // ç»‘å®šå…ƒç´ ï¼ˆå®¹é”™ï¼‰
                downloadProgress = document.getElementById('downloadProgress') || {};
                progressBar = document.getElementById('progressBar') || {};
                progressText = document.getElementById('progressText') || {};
                downloadBtn = document.getElementById('downloadBtn') || {};
                updateBtn = document.getElementById('updateBtn') || {};
                fileDownloadBtn = document.getElementById('fileDownloadBtn') || {};
            }

            // 4. æ ¸å¿ƒ4ï¼šè‡ªåŠ¨å¼¹çª—æé†’+åˆ‡æ¢é¢æ¿ï¼ˆæ”¶åˆ°æ–°å…¬å‘Šå³è§¦å‘ï¼‰
            function autoNotifyAndSwitchPanel(tip = 'æ”¶åˆ°æ–°å…¬å‘Š') {
                // 1. ç³»ç»Ÿé€šçŸ¥ï¼ˆæµè§ˆå™¨å¼¹çª—ï¼‰
                if (Notification.permission === 'granted') {
                    new Notification(tip, {
                        body: `${currentNoticeData.title || 'æ–°å…¬å‘Š'}\næ›´æ–°æ—¶é—´ï¼š${currentNoticeData.date}`,
                        icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    // æœªè¯·æ±‚æƒé™ï¼Œè‡ªåŠ¨è¯·æ±‚
                    Notification.requestPermission().then(perm => {
                        if (perm === 'granted') {
                            new Notification(tip, {
                                body: `${currentNoticeData.title || 'æ–°å…¬å‘Š'}\næ›´æ–°æ—¶é—´ï¼š${currentNoticeData.date}`,
                                icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                            });
                        }
                    });
                }

                // 2. é¡µé¢å†…å¼¹çª—æé†’
                alert(`ğŸ‰ ${tip}ï¼š${currentNoticeData.title || 'æœªå‘½åå…¬å‘Š'}${currentNoticeData.file ? 'ï¼ˆå«HTMLæ–‡ä»¶ï¼‰' : ''}`);

                // 3. è‡ªåŠ¨åˆ‡æ¢åˆ°å…¬å‘Šé¢æ¿ï¼ˆç¡®ä¿ç”¨æˆ·çœ‹åˆ°ï¼‰
                if (!panelNotice.classList.contains('active')) {
                    switchContentPanel('panelNotice');
                }

                // 4. å±•å¼€æ‚¬æµ®çƒé¢æ¿ï¼ˆè‹¥æœªå±•å¼€ï¼‰
                if (!floatWindow.classList.contains('active')) {
                    floatWindow.classList.add('active');
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }

            // 5. åˆå§‹åŒ–æµç¨‹ï¼ˆé¡µé¢åŠ è½½å³è§¦å‘ï¼Œå…¨è‡ªåŠ¨ï¼‰
            document.addEventListener('DOMContentLoaded', () => {
                // 1. åˆå§‹åŒ–WebSocketï¼ˆå®æ—¶æ¥æ”¶ï¼‰
                initWebSocket();
                // 2. é¡µé¢åŠ è½½åç«‹å³æ‹‰å–ï¼ˆè¡¥æ”¶ç¦»çº¿æ›´æ–°ï¼‰
                autoFetchLatestAnnouncement();
                // 3. æ£€æŸ¥ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼ˆå¿«é€ŸåŠ è½½ï¼‰
                checkCachedPage();
            });

            // 6. é¢æ¿åˆ‡æ¢ï¼ˆåˆ‡æ¢åˆ°å…¬å‘Šé¢æ¿æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°æœ€æ–°æ•°æ®ï¼‰
            function switchContentPanel(targetId) {
                funcButtons.style.display = 'none';
                [panelMy, panelNotice, panelContact, panelSetting].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                document.getElementById(targetId).classList.add('active');
                document.getElementById(targetId).style.display = 'block';
                modalBack.style.display = 'block';
                isInMainPanel = false;

                // åˆ‡æ¢åˆ°å…¬å‘Šé¢æ¿ï¼Œè‡ªåŠ¨æ‹‰å–æœ€æ–°æ•°æ®ï¼ˆå…œåº•ï¼‰
                if (targetId === 'panelNotice') {
                    autoFetchLatestAnnouncement();
                }
            }

            function backToMainPanel() {
                [panelMy, panelNotice, panelContact, panelSetting].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                funcButtons.style.display = 'flex';
                modalBack.style.display = 'none';
                isInMainPanel = true;
            }

            // 7. ä¸‹è½½ã€æ›´æ–°é€»è¾‘ï¼ˆä¿ç•™ï¼Œå¢åŠ å®¹é”™ï¼‰
            function startDownload() {
                if (downloadInterval) clearInterval(downloadInterval);
                if (!downloadProgress || !progressBar || !progressText || !downloadBtn) {
                    alert('âŒ ä¸‹è½½å…ƒç´ æœªåŠ è½½ï¼Œè¯·ç¨ç­‰é‡è¯•');
                    return;
                }

                downloadProgress.style.display = 'block';
                downloadBtn.textContent = 'ä¸‹è½½ä¸­';
                downloadBtn.disabled = true;
                progressBar.style.width = '0%';
                progressText.textContent = 'è¿›åº¦ï¼š0%';

                let progress = 0;
                downloadInterval = setInterval(() => {
                    progress += 1;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `è¿›åº¦ï¼š${progress}%`;

                    if (progress >= 100) {
                        clearInterval(downloadInterval);
                        downloadBtn.style.display = 'none';
                        if (updateBtn) updateBtn.style.display = 'block';
                        setTimeout(() => {
                            downloadBtn.textContent = 'é‡æ–°ä¸‹è½½';
                            downloadBtn.disabled = false;
                        }, 1000);
                    }
                }, 30);
            }

            async function downloadFile() {
                if (!currentNoticeData || !currentNoticeData.file) {
                    alert('âŒ æ— å¯ç”¨æ–‡ä»¶ï¼Œæ— æ³•ä¸‹è½½');
                    return;
                }

                try {
                    const file = currentNoticeData.file;
                    const fileName = file.name || 'æœªå‘½å.html';
                    let fileContent = file.content;

                    // å…œåº•ï¼šæ–‡ä»¶å†…å®¹ç¼ºå¤±æ—¶ï¼Œä»åç«¯æ‹‰å–
                    if (!fileContent) {
                        alert('ğŸ” æ–‡ä»¶å†…å®¹åŠ è½½ä¸­ï¼Œç¨ç­‰...');
                        const res = await fetch(`https://${config.domain}.onrender.com/downloadLatestFile`);
                        if (!res.ok) throw new Error(`è·å–æ–‡ä»¶å¤±è´¥ï¼ˆ${res.status}ï¼‰`);
                        fileContent = await res.text();
                    }

                    // è§¦å‘ä¸‹è½½
                    const blob = new Blob([fileContent], { type: 'text/html; charset=utf-8' });
                    const downloadLink = document.createElement('a');
                    downloadLink.href = URL.createObjectURL(blob);
                    downloadLink.download = fileName;
                    downloadLink.click();
                    URL.revokeObjectURL(downloadLink.href);

                    // è®°å½•ç¼“å­˜
                    if (!cachedFileNames.includes(fileName)) {
                        cachedFileNames.push(fileName);
                        localStorage.setItem('cachedFileNames', JSON.stringify(cachedFileNames));
                    }

                    alert(`ğŸ“¥ å·²è§¦å‘${fileName}ä¸‹è½½ï¼ŒæŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½æ `);
                } catch (err) {
                    console.error('âŒ ä¸‹è½½å¤±è´¥ï¼š', err);
                    alert(`ä¸‹è½½å¤±è´¥ï¼š${err.message}ï¼Œè¯·ç¨ç­‰é‡è¯•`);
                }
            }

            function markAsUpdated() {
                if (!confirm('âš ï¸ ç¡®è®¤æ›´æ–°ï¼Ÿæ›´æ–°åé¡µé¢æ›¿æ¢ä¸ºæœ€æ–°ç‰ˆï¼Œæ—§ç‰ˆç¼“å­˜æœ¬åœ°')) {
                    return;
                }

                try {
                    let fileContent = currentNoticeData?.file?.content;

                    // å…œåº•ï¼šå†…å®¹ç¼ºå¤±æ—¶æ‹‰å–
                    if (!fileContent) {
                        alert('ğŸ” æ­£åœ¨æ‹‰å–æœ€æ–°å†…å®¹ï¼Œç¨ç­‰...');
                        fetch(`https://${config.domain}.onrender.com/downloadLatestFile`)
                            .then(res => {
                                if (!res.ok) throw new Error(`æ‹‰å–å¤±è´¥`);
                                return res.text();
                            })
                            .then(content => {
                                localStorage.setItem('latestPage', content);
                                document.documentElement.innerHTML = content;
                                alert('âœ… æ›´æ–°æˆåŠŸï¼å½“å‰å·²æ˜¯æœ€æ–°å†…å®¹');
                            })
                            .catch(err => {
                                alert(`âŒ æ›´æ–°å¤±è´¥ï¼š${err.message}`);
                            });
                        return;
                    }

                    // æ­£å¸¸æ›´æ–°
                    localStorage.setItem('latestPage', fileContent);
                    const statusBadge = pushNotice.querySelector('.status-badge.status-new');
                    if (statusBadge) {
                        statusBadge.textContent = 'å·²æ›´æ–°ï¼ˆå¸¸é©»ï¼‰';
                        statusBadge.classList.remove('status-new');
                        statusBadge.classList.add('status-updated');
                    }

                    document.documentElement.innerHTML = fileContent;
                    alert('âœ… æ›´æ–°æˆåŠŸï¼å½“å‰å·²æ˜¯æœ€æ–°å†…å®¹');
                } catch (err) {
                    alert(`âŒ æ›´æ–°å¤±è´¥ï¼š${err.message}ï¼Œè¯·ç¨ç­‰é‡è¯•`);
                }
            }

            // 8. ç¼“å­˜é¡µé¢æ£€æŸ¥ï¼ˆé¡µé¢åŠ è½½æ—¶å¿«é€ŸåŠ è½½ï¼‰
            function checkCachedPage() {
                const cachedPage = localStorage.getItem('latestPage');
                if (cachedPage && confirm('ğŸ“Œ æ£€æµ‹åˆ°ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼Œæ˜¯å¦ç›´æ¥åŠ è½½ï¼Ÿ')) {
                    document.documentElement.innerHTML = cachedPage;
                }
            }

            // 9. æ‚¬æµ®çƒæ‹–æ‹½+ç‚¹å‡»é€»è¾‘ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
            floatBtn.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                btnDragStart = { x: touch.clientX, y: touch.clientY, rect: floatBtn.getBoundingClientRect() };
                btnIsDragging = false;
            }, { passive: true });

            floatBtn.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const dx = touch.clientX - btnDragStart.x;
                const dy = touch.clientY - btnDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    btnIsDragging = true;
                    const winW = document.documentElement.clientWidth;
                    const winH = document.documentElement.clientHeight;
                    const safeBottom = utils.getSafeBottom();
                    const boundedLeft = Math.max(20, Math.min(btnDragStart.rect.left + dx, winW - 60 - 20));
                    const boundedTop = Math.max(20, Math.min(btnDragStart.rect.top + dy, winH - 60 - safeBottom - 20));
                    floatBtn.style.left = `${boundedLeft}px`;
                    floatBtn.style.top = `${boundedTop}px`;
                }
            }, { passive: false });

            floatBtn.addEventListener('click', () => {
                if (btnIsDragging) return;
                floatWindow.classList.toggle('active');
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            });

            windowHeader.addEventListener('touchstart', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                winDragStart = { x: touch.clientX, y: touch.clientY, rect: floatWindow.getBoundingClientRect() };
                winIsDragging = false;
            }, { passive: true });

            windowHeader.addEventListener('touchmove', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                const dx = touch.clientX - winDragStart.x;
                const dy = touch.clientY - winDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    winIsDragging = true;
                    currentWindowPos = { left: winDragStart.rect.left + dx, top: winDragStart.rect.top + dy };
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }, { passive: false });

            // é¢æ¿æŒ‰é’®ç‚¹å‡»
            modalBack.addEventListener('click', (e) => { e.stopPropagation(); backToMainPanel(); });
            btnMy.addEventListener('click', (e) => { e.stopPropagation(); switchContentPanel('panelMy'); });
            btnNotice.addEventListener('click', (e) => { e.stopPropagation(); switchContentPanel('panelNotice'); });
            btnContact.addEventListener('click', (e) => { e.stopPropagation(); switchContentPanel('panelContact'); });
            btnSetting.addEventListener('click', (e) => { e.stopPropagation(); switchContentPanel('panelSetting'); });

            // 10. é¡µé¢åˆå§‹åŒ–+resizeï¼ˆä¿ç•™ï¼‰
            window.addEventListener('load', () => {
                const winW = document.documentElement.clientWidth;
                const winH = document.documentElement.clientHeight;
                const safeBottom = utils.getSafeBottom();
                floatBtn.style.left = `${winW - 60 - 20}px`;
                floatBtn.style.top = `${winH - 60 - safeBottom - 20}px`;
                autoRenderNotice();
            });

            window.addEventListener('resize', () => {
                const winW = document.documentElement.clientWidth;
                const winH = document.documentElement.clientHeight;
                const safeBottom = utils.getSafeBottom();
                floatBtn.style.left = `${winW - 60 - 20}px`;
                floatBtn.style.top = `${winH - 60 - safeBottom - 20}px`;
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            });

            // 11. è¾…åŠ©å‡½æ•°
            function hideLoadTip() { loadTip.style.display = 'none'; }
            function showErrorTip() { loadTip.textContent = 'âŒ é¡µé¢åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ç­‰é‡è¯•'; }

            // å…¨å±€ç»‘å®š
            window.startDownload = startDownload;
            window.markAsUpdated = markAsUpdated;
            window.downloadFile = downloadFile;
            window.hideLoadTip = hideLoadTip;
            window.showErrorTip = showErrorTip;
        })();
    </script>
</body>
</html>
