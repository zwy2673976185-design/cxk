<!DOCTYPE html>
<html>
<head>
  <title>å‰ç«¯æ›´æ–°æ¥æ”¶é¡µ</title>
  <style>
    #noticeArea { 
      border: 2px solid #ff6700; 
      padding: 20px; 
      margin: 30px auto; 
      max-width: 600px; 
      background: #fff8f0;
      border-radius: 8px;
    }
    .notice-title { 
      color: #ff6700; 
      font-weight: bold; 
      font-size: 16px; 
      margin-bottom: 15px;
    }
    .notice-content p { 
      margin: 8px 0; 
      color: #333; 
    }
    button { 
      margin: 10px 10px 0 0; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
    }
    #downloadBtn { 
      background: #2d7dff; 
      color: #fff; 
    }
    #updateBtn { 
      background: #ff6700; 
      color: #fff; 
    }
    #noNotice { 
      text-align: center; 
      color: #666; 
      padding: 10px;
    }
    .page-title { 
      text-align: center; 
      color: #333; 
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <h1 class="page-title">å½“å‰é¡µé¢ï¼ˆæœªæ›´æ–°å‰ï¼Œå…¬å‘Šä¸ä¼šæ¶ˆå¤±ï¼‰</h1>

  <div id="noticeArea">
    <div class="notice-title">ğŸ“¢ å¾…æ›´æ–°å…¬å‘Š</div>
    <div id="noticeContent">
      <div id="loading">åŠ è½½ä¸­...æ­£åœ¨è·å–æœ€æ–°æ›´æ–°ä¿¡æ¯</div>
    </div>
  </div>

<script>
// æ›¿æ¢ä¸ºä½ çš„RenderæœåŠ¡åŸŸåï¼ˆå¦‚ä½ çš„æœåŠ¡åä¸ºcxk-z875ï¼Œåˆ™æ— éœ€ä¿®æ”¹ï¼‰
const renderDomain = "cxk-z875"; 

window.onload = () => {
  getNotice();
  checkCachedUpdate();
};

async function getNotice() {
  const noticeContent = document.getElementById('noticeContent');
  try {
    const res = await fetch(`https://${renderDomain}.onrender.com/getNoticeInfo`);
    const data = await res.json();

    if (data.success) {
      noticeContent.innerHTML = `
        <div class="notice-content">
          <p>ğŸ“„ æ–‡ä»¶åç§°ï¼š${data.notice.fileName}</p>
          <p>ğŸ“Š æ–‡ä»¶å¤§å°ï¼š${data.notice.size}</p>
          <p>â° æ¨é€æ—¶é—´ï¼š${data.notice.updateTime}</p>
          <button id="downloadBtn" onclick="downloadFile()">1. ä¸‹è½½æœ€æ–°æ–‡ä»¶</button>
          <button id="updateBtn" onclick="doUpdate()">2. ç¡®è®¤æ›´æ–°ï¼ˆæ›´æ–°åå…¬å‘Šæ¶ˆå¤±ï¼‰</button>
        </div>
      `;
    } else {
      noticeContent.innerHTML = `<div id="noNotice">${data.notice}</div>`;
    }
  } catch (err) {
    noticeContent.innerHTML = `<div id="noNotice">âŒ å…¬å‘ŠåŠ è½½å¤±è´¥ï¼š${err.message}ï¼ˆæ£€æŸ¥åŸŸåæ˜¯å¦æ­£ç¡®ï¼‰</div>`;
  }
}

function downloadFile() {
  window.open(`https://${renderDomain}.onrender.com/downloadLatestFile`, '_blank');
  alert('ğŸ“¥ ä¸‹è½½å·²å¯åŠ¨ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸‹è½½æ æŸ¥çœ‹è¿›åº¦ï¼');
}

async function doUpdate() {
  if (!confirm('âš ï¸ ç¡®è®¤è¦æ›´æ–°å—ï¼Ÿæ›´æ–°åé¡µé¢å°†ç›´æ¥å˜ä¸ºæœ€æ–°ç‰ˆï¼Œæ—§ç‰ˆæš‚å­˜ç¼“å­˜ï¼')) {
    return;
  }

  const noticeArea = document.getElementById('noticeArea');
  try {
    const res = await fetch(`https://${renderDomain}.onrender.com/downloadLatestFile`);
    if (!res.ok) throw new Error('è·å–æœ€æ–°æ–‡ä»¶å¤±è´¥ï¼Œè¯·å…ˆç¡®è®¤å·²ä¸‹è½½æ–‡ä»¶');

    const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = (e) => {
      document.documentElement.innerHTML = e.target.result;
      localStorage.setItem('latestPage', e.target.result);
      alert('âœ… æ›´æ–°æˆåŠŸï¼é¡µé¢å·²å˜ä¸ºæœ€æ–°ç‰ˆï¼Œå…¬å‘Šå·²éšè—');
    };
    reader.readAsText(blob);
  } catch (err) {
    alert('âŒ æ›´æ–°å¤±è´¥ï¼š' + err.message);
  }
}

function checkCachedUpdate() {
  const cachedPage = localStorage.getItem('latestPage');
  if (cachedPage && confirm('ğŸ“Œ æ£€æµ‹åˆ°ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼Œæ˜¯å¦ç›´æ¥åŠ è½½ï¼Ÿï¼ˆæ— éœ€é‡æ–°æ›´æ–°ï¼‰')) {
    document.documentElement.innerHTML = cachedPage;
  }
}
</script>
</body>
</html>
