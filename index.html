<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>悬浮功能面板（按钮切换修复版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        body { height: 100vh; overflow: hidden; position: relative; background: #f5f7fa; }
        
        .float-btn { 
            position: fixed; z-index: 1002; width: 60px; height: 60px; border-radius: 0; box-shadow: 0 3px 15px rgba(0,0,0,0.3); 
            cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; transition: transform 0.2s ease, box-shadow 0.2s ease; 
            background-image: url(https://i.imgs.ovh/2025/09/28/75fraO.jpeg); background-color: #f0f0f0; 
            background-size: cover; background-position: center; background-repeat: no-repeat; 
            padding: 0; margin: 0; border: none; right: 20px; bottom: 50px; 
        }
        .float-btn:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        
        .float-window { 
            position: fixed; z-index: 1001; width: 300px; height: 280px; background: white; border-radius: 12px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.15); overflow: hidden; display: none; opacity: 0; transition: opacity 0.3s ease; 
        }
        .float-window.active { display: block; opacity: 1; }
        
        .window-header { 
            padding: 12px 15px; background: linear-gradient(90deg, #2563eb, #3b82f6); color: white; 
            font-size: 16px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; 
            cursor: move; -webkit-tap-highlight-color: transparent; height: 44px; 
        }
        .modal-back { 
            background: transparent; border: none; color: white; font-size: 14px; cursor: pointer; 
            padding: 4px 8px; border-radius: 4px; transition: background 0.2s ease; display: none; -webkit-tap-highlight-color: transparent; 
        }
        .modal-back:hover { background: rgba(255,255,255,0.1); }
        
        .func-buttons { 
            padding: 10px; display: flex; flex-direction: column; gap: 10px; 
            max-height: calc(280px - 44px); overflow-y: auto; -webkit-overflow-scrolling: touch; 
        }
        .func-btn { 
            padding: 12px 15px; border-radius: 8px; background: #f8f9fa; font-size: 14px; color: #333; 
            text-align: left; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; 
            display: flex; align-items: center; justify-content: space-between; 
            -webkit-tap-highlight-color: transparent; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .func-btn:hover { background: #f1f3f5; transform: translateY(-1px); }
        .btn-icon { width: 20px; height: 20px; opacity: 0.7; }
        
        .content-panel { 
            padding: 15px; max-height: calc(280px - 44px); overflow-y: auto; 
            -webkit-overflow-scrolling: touch; display: none; 
        }
        .content-panel.active { display: block; }
        
        /* 纯自定义公告样式：仅展示用户填写的标题和内容 */
        .notice-item { 
            padding: 10px 0; display: block; 
        }
        .notice-title { 
            font-size: 18px; font-weight: 600; color: #2563eb; margin-bottom: 5px; 
        }
        .notice-time { 
            font-size: 12px; color: #999; margin-bottom: 8px; 
        }
        .notice-content { 
            font-size: 14px; color: #333; line-height: 1.5; margin-bottom: 10px; word-break: break-word; 
        }
        .progress-actions { 
            display: flex; align-items: center; gap: 10px; 
        }
        .download-progress { 
            flex: 1; height: 6px; background: #ebf2ff; border-radius: 3px; overflow: hidden; 
        }
        .progress-bar { 
            height: 100%; background: #2563eb; border-radius: 3px; width: 0%; transition: width 0.03s linear; 
        }
        .action-btn { 
            padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; 
            cursor: pointer; transition: background 0.2s ease; white-space: nowrap; 
        }
        .download-btn { 
            background: #2563eb; color: white; box-shadow: 0 1px 3px rgba(37, 99, 235, 0.2); 
        }
        .download-btn:disabled { 
            background: #93c5fd; cursor: not-allowed; 
        }
        .update-btn { 
            background: #10b981; color: white; box-shadow: 0 1px 3px rgba(16, 185, 129, 0.2); display: block; /* 确保显示 */
        }
        .file-tip { 
            font-size: 11px; color: #999; margin-top: 5px; text-align: right; 
        }
        .empty-tip { 
            text-align: center; 
            color: #999; 
            font-size: 14px; 
            line-height: 1.5; 
            padding: 20px 0; 
            border: none; 
            background: transparent; 
        }
    </style>
</head>
<body>
    <button class="float-btn" id="floatBtn"></button>
    <div class="float-window" id="floatWindow">
        <div class="window-header" id="windowHeader">
            功能面板
            <button class="modal-back" id="modalBack">返回</button>
        </div>
        <div class="func-buttons" id="funcButtons">
            <button class="func-btn" id="btnMy">
                <span>我的</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/user--v1.png" class="btn-icon" alt="我的">
            </button>
            <button class="func-btn" id="btnNotice">
                <span>公告更新</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/announcement--v1.png" class="btn-icon" alt="公告更新">
            </button>
            <button class="func-btn" id="btnContact">
                <span>联系作者</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/contact-card--v1.png" class="btn-icon" alt="联系作者">
            </button>
            <button class="func-btn" id="btnSetting">
                <span>设置</span>
                <img src="https://img.icons8.com/ios-glyphs/30/666/settings--v1.png" class="btn-icon" alt="设置">
            </button>
        </div>
        <div class="content-panel" id="panelNotice">
            <div id="noticeContainer">
                <div class="empty-tip" id="defaultTip">加载最新公告中...</div>
                <div class="notice-item" id="pushNotice"></div>
            </div>
        </div>
        <div class="content-panel" id="panelMy">
            <div class="user-name">用一生找寻</div>
            <div class="user-desc">当前功能待开发，暂显示用户名</div>
        </div>
        <div class="content-panel" id="panelContact">
            <div class="empty-tip">点击下方链接联系作者<br><a href="https://qzone.qq.com/2673976185" target="_blank" style="color: #2563eb; text-decoration: none;">前往作者QQ空间</a></div>
        </div>
        <div class="content-panel" id="panelSetting">
            <div class="empty-tip">设置功能待开发</div>
        </div>
    </div>

    <script>
        (function() {
            if (window.floatingWindowInjected) return;
            window.floatingWindowInjected = true;

            const config = { 
                domain: "cxk-z875", // 你的Render服务名，必须和后端一致
                latestNoticeKey: "latestReceivedNotice" // localStorage存储最新公告的key
            };

            const utils = {
                // 获取安全底部边距
                getSafeBottom() { 
                    const p = parseFloat(getComputedStyle(document.body).paddingBottom); 
                    return isNaN(p) ? 20 : p; 
                },
                // 检查窗口边界
                checkWindowBound(left, top) { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    const sb = utils.getSafeBottom(); 
                    return { 
                        left: Math.max(20, Math.min(left, w - 300 - 20)), 
                        top: Math.max(20, Math.min(top, h - 280 - sb - 20)) 
                    }; 
                },
                // 获取默认窗口位置
                getDefaultWindowPos() { 
                    const w = document.documentElement.clientWidth; 
                    const h = document.documentElement.clientHeight; 
                    return utils.checkWindowBound((w-300)/2, (h-280)/2); 
                },
                // 格式化时间（紧凑美观）
                formatTime(dateStr) {
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}年${String(date.getMonth() + 1).padStart(2, '0')}月${String(date.getDate()).padStart(2, '0')}日`;
                },
                // 从localStorage获取最新公告（新用户/刷新后仍能显示）
                getLatestNoticeFromStorage() {
                    const noticeStr = localStorage.getItem(config.latestNoticeKey);
                    return noticeStr ? JSON.parse(noticeStr) : null;
                },
                // 保存最新公告到localStorage
                saveLatestNoticeToStorage(notice) {
                    localStorage.setItem(config.latestNoticeKey, JSON.stringify(notice));
                }
            };

            // 元素引用
            const floatBtn = document.getElementById('floatBtn');
            const floatWindow = document.getElementById('floatWindow');
            const modalBack = document.getElementById('modalBack');
            const funcButtons = document.getElementById('funcButtons');
            const btnMy = document.getElementById('btnMy');
            const btnNotice = document.getElementById('btnNotice');
            const btnContact = document.getElementById('btnContact');
            const btnSetting = document.getElementById('btnSetting');
            const panelNotice = document.getElementById('panelNotice');
            const defaultTip = document.getElementById('defaultTip');
            const pushNotice = document.getElementById('pushNotice');

            // 状态变量
            let btnIsDragging = false, winIsDragging = false, isInMainPanel = true;
            let currentWindowPos = utils.getDefaultWindowPos();
            let currentNoticeData = utils.getLatestNoticeFromStorage() || null; // 优先从localStorage读取最新公告
            let downloadInterval = null;
            let btnDragStart = null, winDragStart = null;

            // -------------------------- 核心1：WebSocket实时接收（确保新老用户都能收到最新） --------------------------
            let ws;
            let reconnectCount = 0;
            const RECONNECT_DELAY = 1000;

            function initWebSocket() {
                if (ws) {
                    ws.close();
                    ws = null;
                }

                ws = new WebSocket(`wss://${config.domain}.onrender.com`);

                // 连接成功：拉取最新公告（兜底，确保WebSocket未收到时也能获取）
                ws.onopen = () => {
                    reconnectCount = 0;
                    console.log('✅ WebSocket连接成功');
                    autoFetchLatestAnnouncement(); // 主动拉取，避免WebSocket消息丢失
                };

                // 连接断开：自动重连
                ws.onclose = () => {
                    reconnectCount++;
                    console.log(`❌ WebSocket断开，${RECONNECT_DELAY}ms后重连（第${reconnectCount}次）`);
                    setTimeout(initWebSocket, RECONNECT_DELAY);
                };

                // 连接错误：重连
                ws.onerror = (err) => {
                    console.error('❌ WebSocket错误：', err);
                    if (ws.readyState !== WebSocket.CLOSED) {
                        ws.close();
                    }
                };

                // 实时接收新公告：覆盖旧数据，更新localStorage
                ws.onmessage = (e) => {
                    console.log('📥 实时收到更新数据：', e.data);
                    try {
                        const newData = JSON.parse(e.data);
                        if (newData.type === 'notice') {
                            // 覆盖为最新公告，更新localStorage
                            currentNoticeData = newData;
                            utils.saveLatestNoticeToStorage(newData);
                            autoRenderNotice(); // 重新渲染
                            autoNotifyAndSwitchPanel(); // 通知用户
                        }
                    } catch (err) {
                        console.error('❌ 解析更新数据失败：', err);
                    }
                };
            }

            // -------------------------- 核心2：自动拉取最新公告（新用户/刷新后必执行） --------------------------
            async function autoFetchLatestAnnouncement() {
                try {
                    console.log('🔍 拉取最新公告（新老用户通用）');
                    const res = await fetch(`https://${config.domain}.onrender.com/getLatestAnnouncement`);
                    if (!res.ok) throw new Error(`请求失败（状态码：${res.status}）`);

                    const result = await res.json();
                    if (result.success && result.data) {
                        // 无论是否新用户，都用后端最新数据覆盖
                        currentNoticeData = result.data;
                        utils.saveLatestNoticeToStorage(result.data); // 保存到localStorage，下次打开仍在
                        autoRenderNotice();
                    } else if (!currentNoticeData) {
                        // 后端暂无数据且localStorage也没有：显示空提示
                        defaultTip.style.display = 'block';
                        pushNotice.style.display = 'none';
                    } else {
                        // 后端暂无新数据，但localStorage有旧数据：显示旧数据（确保老用户仍能看到）
                        autoRenderNotice();
                    }
                } catch (err) {
                    console.error('❌ 拉取公告失败：', err);
                    // 失败后仍显示localStorage中的数据（断网时也能看到历史最新）
                    if (currentNoticeData) {
                        autoRenderNotice();
                    } else {
                        defaultTip.textContent = '暂无公告';
                    }
                    // 10秒后重试（网络恢复后自动获取）
                    setTimeout(autoFetchLatestAnnouncement, 10000);
                }
            }

            // -------------------------- 核心3：渲染公告（仅显示用户自定义的标题和内容） --------------------------
            function autoRenderNotice() {
                if (!currentNoticeData || !currentNoticeData.title || !currentNoticeData.content) {
                    defaultTip.style.display = 'block';
                    pushNotice.style.display = 'none';
                    return;
                }

                // 仅显示用户在发送端填写的标题、内容，无任何系统自动文字
                const title = currentNoticeData.title;
                const formattedTime = utils.formatTime(currentNoticeData.date || new Date());
                const content = currentNoticeData.content;

                // 渲染HTML（完全自定义，无系统自动前缀）
                const noticeHtml = `
                    <div class="notice-title">${title}</div>
                    <div class="notice-time">更新时间：${formattedTime}</div>
                    <div class="notice-content">${content}</div>
                    <div class="progress-actions">
                        <div class="download-progress" id="downloadProgress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <button class="action-btn download-btn" id="downloadBtn" onclick="startDownload()">下载</button>
                    </div>
                `;

                pushNotice.innerHTML = noticeHtml;
                defaultTip.style.display = 'none';
                pushNotice.style.display = 'block';
            }

            // -------------------------- 核心4：下载→更新按钮切换逻辑（修复消失问题） --------------------------
            // 下载逻辑
            window.startDownload = function() {
                const downloadProgress = document.getElementById('downloadProgress');
                const progressBar = document.getElementById('progressBar');
                const downloadBtn = document.getElementById('downloadBtn');

                if (!downloadProgress || !progressBar || !downloadBtn || !currentNoticeData?.file) return;

                // 初始化进度条和按钮
                downloadBtn.textContent = '下载中';
                downloadBtn.disabled = true;
                progressBar.style.width = '0%';

                // 模拟进度（实际项目可替换为真实下载进度）
                let progress = 0;
                downloadInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    if (progress >= 100) {
                        clearInterval(downloadInterval);
                        // 下载完成：切换为“更新”按钮
                        downloadBtn.textContent = '更新';
                        downloadBtn.className = 'action-btn update-btn';
                        downloadBtn.onclick = markAsUpdated;
                        downloadBtn.disabled = false;
                    }
                }, 100);
            };

            // 更新逻辑
            window.markAsUpdated = async function() {
                if (!confirm('⚠️ 确认更新？更新后页面将替换为最新版')) return;

                try {
                    let fileContent = currentNoticeData?.file?.content;

                    // 兜底：从后端拉取最新内容
                    if (!fileContent) {
                        alert('🔍 正在拉取最新内容...');
                        const res = await fetch(`https://${config.domain}.onrender.com/downloadLatestFile`);
                        if (!res.ok) throw new Error(`拉取失败（${res.status}）`);
                        fileContent = await res.text();
                    }

                    // 更新页面
                    document.documentElement.innerHTML = fileContent;
                    alert('✅ 更新成功！当前已是最新内容');
                } catch (err) {
                    alert(`❌ 更新失败：${err.message}，请稍等重试`);
                }
            };

            // -------------------------- 其他辅助功能 --------------------------
            // 自动通知并切换面板
            function autoNotifyAndSwitchPanel(tip = '收到最新公告') {
                // 系统通知
                if (Notification.permission === 'granted') {
                    new Notification(tip, {
                        body: `${currentNoticeData.title}\n${utils.formatTime(currentNoticeData.date)}`,
                        icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(perm => {
                        if (perm === 'granted') {
                            new Notification(tip, {
                                body: `${currentNoticeData.title}\n${utils.formatTime(currentNoticeData.date)}`,
                                icon: 'https://img.icons8.com/ios-glyphs/30/2563eb/announcement--v1.png'
                            });
                        }
                    });
                }

                // 弹窗提醒
                alert(`🎉 ${tip}：${currentNoticeData.title}`);

                // 自动切换到公告面板
                if (!panelNotice.classList.contains('active')) {
                    switchContentPanel('panelNotice');
                }

                // 展开悬浮窗口
                if (!floatWindow.classList.contains('active')) {
                    floatWindow.classList.add('active');
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }

            // 面板切换
            function switchContentPanel(targetId) {
                funcButtons.style.display = 'none';
                [panelNotice, document.getElementById('panelMy'), document.getElementById('panelContact'), document.getElementById('panelSetting')].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                document.getElementById(targetId).classList.add('active');
                document.getElementById(targetId).style.display = 'block';
                modalBack.style.display = 'block';
                isInMainPanel = false;

                // 切换到公告面板时，确保显示最新数据
                if (targetId === 'panelNotice') {
                    autoRenderNotice();
                }
            }

            // 返回主面板
            function backToMainPanel() {
                [panelNotice, document.getElementById('panelMy'), document.getElementById('panelContact'), document.getElementById('panelSetting')].forEach(panel => {
                    panel.classList.remove('active');
                    panel.style.display = 'none';
                });
                funcButtons.style.display = 'flex';
                modalBack.style.display = 'none';
                isInMainPanel = true;
            }

            // 悬浮球拖拽
            floatBtn.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                btnDragStart = { x: touch.clientX, y: touch.clientY, rect: floatBtn.getBoundingClientRect() };
                btnIsDragging = false;
            }, { passive: true });

            floatBtn.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const dx = touch.clientX - btnDragStart.x;
                const dy = touch.clientY - btnDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    btnIsDragging = true;
                    const winW = document.documentElement.clientWidth;
                    const winH = document.documentElement.clientHeight;
                    const safeBottom = utils.getSafeBottom();
                    const boundedLeft = Math.max(20, Math.min(btnDragStart.rect.left + dx, winW - 60 - 20));
                    const boundedTop = Math.max(20, Math.min(btnDragStart.rect.top + dy, winH - 60 - safeBottom - 20));
                    floatBtn.style.left = `${boundedLeft}px`;
                    floatBtn.style.top = `${boundedTop}px`;
                }
            }, { passive: false });

            // 悬浮球点击
            floatBtn.addEventListener('click', () => {
                if (btnIsDragging) return;
                floatWindow.classList.toggle('active');
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.getDefaultWindowPos();
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                    // 展开时确保显示最新公告
                    autoRenderNotice();
                }
            });

            // 面板拖拽
            document.getElementById('windowHeader').addEventListener('touchstart', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                winDragStart = { x: touch.clientX, y: touch.clientY, rect: floatWindow.getBoundingClientRect() };
                winIsDragging = false;
            }, { passive: true });

            document.getElementById('windowHeader').addEventListener('touchmove', (e) => {
                if (!floatWindow.classList.contains('active')) return;
                const touch = e.touches[0];
                const dx = touch.clientX - winDragStart.x;
                const dy = touch.clientY - winDragStart.y;
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    winIsDragging = true;
                    currentWindowPos = { left: winDragStart.rect.left + dx, top: winDragStart.rect.top + dy };
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            }, { passive: false });

            // 面板按钮点击
            modalBack.addEventListener('click', () => backToMainPanel());
            btnMy.addEventListener('click', () => switchContentPanel('panelMy'));
            btnNotice.addEventListener('click', () => switchContentPanel('panelNotice'));
            btnContact.addEventListener('click', () => switchContentPanel('panelContact'));
            btnSetting.addEventListener('click', () => switchContentPanel('panelSetting'));

            // -------------------------- 初始化（新老用户通用） --------------------------
            document.addEventListener('DOMContentLoaded', () => {
                // 1. 优先渲染localStorage中的最新公告（新用户为空，老用户有数据）
                autoRenderNotice();
                // 2. 初始化WebSocket（实时接收新公告）
                initWebSocket();
                // 3. 主动拉取最新公告（兜底，确保WebSocket未连接时也能获取）
                autoFetchLatestAnnouncement();
            });

            // 窗口resize适配
            window.addEventListener('resize', () => {
                if (floatWindow.classList.contains('active')) {
                    currentWindowPos = utils.checkWindowBound(currentWindowPos.left, currentWindowPos.top);
                    floatWindow.style.left = `${currentWindowPos.left}px`;
                    floatWindow.style.top = `${currentWindowPos.top}px`;
                }
            });
        })();
    </script>
</body>
</html>
