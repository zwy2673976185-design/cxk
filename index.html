<!DOCTYPE html>
<html>
<head>
  <title>å‰ç«¯æ›´æ–°æ¥æ”¶é¡µ</title>
  <style>
    /* å…¬å‘ŠåŒºæ ·å¼ï¼šçªå‡ºæ˜¾ç¤ºï¼Œé¿å…å¿½ç•¥ï¼ˆæœªæ›´æ–°å‰ä¸€ç›´å­˜åœ¨ï¼‰ */
    #noticeArea { 
      border: 2px solid #ff6700; 
      padding: 20px; 
      margin: 30px auto; 
      max-width: 600px; 
      background: #fff8f0;
      border-radius: 8px;
    }
    .notice-title { 
      color: #ff6700; 
      font-weight: bold; 
      font-size: 16px; 
      margin-bottom: 15px;
    }
    .notice-content p { 
      margin: 8px 0; 
      color: #333; 
    }
    button { 
      margin: 10px 10px 0 0; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
    }
    #downloadBtn { 
      background: #2d7dff; 
      color: #fff; 
    }
    #updateBtn { 
      background: #ff6700; 
      color: #fff; 
    }
    #noNotice { 
      text-align: center; 
      color: #666; 
      padding: 10px;
    }
    /* å½“å‰é¡µé¢æ ‡é¢˜æ ·å¼ */
    .page-title { 
      text-align: center; 
      color: #333; 
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <h1 class="page-title">å½“å‰é¡µé¢ï¼ˆæœªæ›´æ–°å‰ï¼Œå…¬å‘Šä¸ä¼šæ¶ˆå¤±ï¼‰</h1>

  <!-- å…¬å‘ŠåŒºï¼šæ ¸å¿ƒåŒºåŸŸï¼Œæœªæ›´æ–°åˆ™æ°¸ä¹…æ˜¾ç¤ºï¼Œæ›´æ–°åè‡ªåŠ¨éšè—ï¼Œæ–°æ–‡ä»¶æ¨é€è‡ªåŠ¨æ›¿æ¢ -->
  <div id="noticeArea">
    <div class="notice-title">ğŸ“¢ å¾…æ›´æ–°å…¬å‘Š</div>
    <div id="noticeContent">
      <div id="loading">åŠ è½½ä¸­...æ­£åœ¨è·å–æœ€æ–°æ›´æ–°ä¿¡æ¯</div>
    </div>
  </div>

<script>
// 1. æœåŠ¡å™¨é…ç½®ï¼ˆå¿…é¡»æ›¿æ¢æˆä½ çš„æœåŠ¡å™¨IPå’Œç«¯å£ï¼Œå’Œserver.jsä¸€è‡´ï¼‰
const serverIP = "ä½ çš„æœåŠ¡å™¨IP";
const serverPort = "3000";

// 2. é¡µé¢æ‰“å¼€æ—¶ï¼Œè‡ªåŠ¨åŠ è½½å…¬å‘Šï¼ˆæœªæ›´æ–°åˆ™ä¸€ç›´æ˜¾ç¤ºï¼Œä¸‹è½½ä¹Ÿä¸æ¶ˆå¤±ï¼‰
window.onload = () => {
  getNotice(); // åŠ è½½å…¬å‘Š
  checkCachedUpdate(); // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼ˆé¿å…é‡å¤æ›´æ–°ï¼‰
};

// 3. æ ¸å¿ƒï¼šè¯·æ±‚æœåŠ¡å™¨ï¼Œè·å–å…¬å‘Šä¿¡æ¯å¹¶æ¸²æŸ“ï¼ˆæ–°æ–‡ä»¶æ¨é€åï¼Œåˆ·æ–°é¡µé¢å³æ˜¾ç¤ºæœ€æ–°ï¼‰
async function getNotice() {
  const noticeContent = document.getElementById('noticeContent');
  try {
    const res = await fetch(`http://${serverIP}:${serverPort}/getNoticeInfo`);
    const data = await res.json();

    if (data.success) {
      // æ¸²æŸ“å…¬å‘Šï¼šæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯ + ä¸‹è½½æŒ‰é’® + æ›´æ–°æŒ‰é’®ï¼ˆä¸‹è½½åå…¬å‘Šä»åœ¨ï¼Œæ›´æ–°åæ¶ˆå¤±ï¼‰
      noticeContent.innerHTML = `
        <div class="notice-content">
          <p>ğŸ“„ æ–‡ä»¶åç§°ï¼š${data.notice.fileName}</p>
          <p>ğŸ“Š æ–‡ä»¶å¤§å°ï¼š${data.notice.size}</p>
          <p>â° æ¨é€æ—¶é—´ï¼š${data.notice.updateTime}</p>
          <button id="downloadBtn" onclick="downloadFile()">1. ä¸‹è½½æœ€æ–°æ–‡ä»¶</button>
          <button id="updateBtn" onclick="doUpdate()">2. ç¡®è®¤æ›´æ–°ï¼ˆæ›´æ–°åå…¬å‘Šæ¶ˆå¤±ï¼‰</button>
        </div>
      `;
    } else {
      // æ— å¾…æ›´æ–°æ–‡ä»¶æ—¶ï¼Œæ˜¾ç¤ºæç¤º
      noticeContent.innerHTML = `<div id="noNotice">${data.notice}</div>`;
    }
  } catch (err) {
    noticeContent.innerHTML = `<div id="noNotice">âŒ å…¬å‘ŠåŠ è½½å¤±è´¥ï¼š${err.message}ï¼ˆæ£€æŸ¥æœåŠ¡å™¨IP/ç«¯å£æ˜¯å¦æ­£ç¡®ï¼‰</div>`;
  }
}

// 4. æ‰‹åŠ¨ä¸‹è½½æœ€æ–°æ–‡ä»¶ï¼ˆä¸‹è½½åå…¬å‘Šä¸æ¶ˆå¤±ï¼Œæ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°ï¼‰
function downloadFile() {
  // æ–°çª—å£æ‰“å¼€ä¸‹è½½æ¥å£ï¼Œé¿å…å½±å“å½“å‰é¡µé¢
  window.open(`http://${serverIP}:${serverPort}/downloadLatestFile`, '_blank');
  alert('ğŸ“¥ ä¸‹è½½å·²å¯åŠ¨ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸‹è½½æ æŸ¥çœ‹è¿›åº¦ï¼');
}

// 5. æ‰‹åŠ¨æ›´æ–°é¡µé¢ï¼ˆæ›´æ–°åå…¬å‘Šæ¶ˆå¤±ï¼Œé¡µé¢ç›´æ¥æ›¿æ¢ä¸ºæœ€æ–°ç‰ˆï¼‰
async function doUpdate() {
  // äºŒæ¬¡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œ
  if (!confirm('âš ï¸ ç¡®è®¤è¦æ›´æ–°å—ï¼Ÿæ›´æ–°åé¡µé¢å°†ç›´æ¥å˜ä¸ºæœ€æ–°ç‰ˆï¼Œæ—§ç‰ˆæš‚å­˜ç¼“å­˜ï¼')) {
    return;
  }

  const noticeArea = document.getElementById('noticeArea');
  try {
    // è¯·æ±‚æœåŠ¡å™¨è·å–æœ€æ–°æ–‡ä»¶å†…å®¹
    const res = await fetch(`http://${serverIP}:${serverPort}/downloadLatestFile`);
    if (!res.ok) throw new Error('è·å–æœ€æ–°æ–‡ä»¶å¤±è´¥ï¼Œè¯·å…ˆç¡®è®¤å·²ä¸‹è½½æ–‡ä»¶');

    // è§£ææ–‡ä»¶å†…å®¹ï¼Œæ›¿æ¢å½“å‰é¡µé¢
    const blob = await res.blob();
    const reader = new FileReader();
    reader.onload = (e) => {
      // æ ¸å¿ƒï¼šç”¨æœ€æ–°HTMLå†…å®¹è¦†ç›–å½“å‰é¡µé¢
      document.documentElement.innerHTML = e.target.result;
      // ç¼“å­˜æœ€æ–°é¡µé¢ï¼Œä¸‹æ¬¡æ‰“å¼€ç›´æ¥åŠ è½½
      localStorage.setItem('latestPage', e.target.result);
      alert('âœ… æ›´æ–°æˆåŠŸï¼é¡µé¢å·²å˜ä¸ºæœ€æ–°ç‰ˆï¼Œå…¬å‘Šå·²éšè—');
    };
    reader.readAsText(blob);
  } catch (err) {
    alert('âŒ æ›´æ–°å¤±è´¥ï¼š' + err.message);
  }
}

// 6. å¯é€‰ï¼šæ£€æŸ¥ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼ˆä¸‹æ¬¡æ‰“å¼€ç›´æ¥åŠ è½½ï¼Œæ— éœ€é‡å¤æ›´æ–°ï¼‰
function checkCachedUpdate() {
  const cachedPage = localStorage.getItem('latestPage');
  if (cachedPage && confirm('ğŸ“Œ æ£€æµ‹åˆ°ç¼“å­˜çš„æœ€æ–°é¡µé¢ï¼Œæ˜¯å¦ç›´æ¥åŠ è½½ï¼Ÿï¼ˆæ— éœ€é‡æ–°æ›´æ–°ï¼‰')) {
    document.documentElement.innerHTML = cachedPage;
  }
}
</script>
</body>
</html>
